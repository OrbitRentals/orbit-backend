generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum Role {
  FOUNDER
  ADMIN
  MODERATOR
  HOST
  RENTER
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

//////////////////////////////////////////////////////
// USER
//////////////////////////////////////////////////////

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  passwordHash      String
  role              Role     @default(RENTER)

  // üîê EMAIL VERIFICATION
  emailVerified     Boolean  @default(false)
  verificationToken String?  @unique

  // üì± PHONE VERIFICATION
  phone             String?
  phoneVerified     Boolean  @default(false)
  phoneOtpCode      String?
  phoneOtpExpiresAt DateTime?

  // üë§ PROFILE INFO
  firstName         String?
  lastName          String?
  dateOfBirth       DateTime?
  addressLine1      String?
  city              String?
  state             String?
  zip               String?

  // ü™™ LICENSE + IDENTITY (KYC)
  licenseFrontUrl   String?
  licenseBackUrl    String?
  selfieUrl         String?
  verificationStatus VerificationStatus @default(PENDING)

  // üö´ MODERATION
  isSuspended       Boolean  @default(false)
  suspendedUntil    DateTime?
  suspensionReason  String?

  // ‚≠ê Reputation
  ratingAverage     Float    @default(0)
  ratingCount       Int      @default(0)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  //////////////////////////////////////////////////////
  // RELATIONS
  //////////////////////////////////////////////////////

  vehicles          Vehicle[]
  bookings          Booking[]

  sentMessages      Message[] @relation("SentMessages")
  reviewsGiven      Review[]  @relation("ReviewsGiven")
  reviewsReceived   Review[]  @relation("ReviewsReceived")

  @@index([role])
  @@index([isSuspended])
}

//////////////////////////////////////////////////////
// VEHICLE
//////////////////////////////////////////////////////

model Vehicle {
  id          String         @id @default(uuid())
  hostId      String
  make        String
  model       String
  year        Int
  dailyPrice  Int
  description String?
  active      Boolean        @default(true)
  createdAt   DateTime       @default(now())

  host        User           @relation(fields: [hostId], references: [id])
  images      VehicleImage[]
  bookings    Booking[]

  @@index([hostId])
}

//////////////////////////////////////////////////////
// VEHICLE IMAGES
//////////////////////////////////////////////////////

model VehicleImage {
  id        String   @id @default(uuid())
  vehicleId String
  url       String
  isMain    Boolean  @default(false)
  order     Int      @default(0)
  createdAt DateTime @default(now())

  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
}

//////////////////////////////////////////////////////
// BOOKING
//////////////////////////////////////////////////////

model Booking {
  id        String         @id @default(uuid())

  vehicleId String
  userId    String

  startDate DateTime
  endDate   DateTime

  status    BookingStatus  @default(PENDING)
  createdAt DateTime       @default(now())

  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  messages  Message[]
  review    Review?

  @@index([vehicleId])
  @@index([userId])
  @@index([vehicleId, startDate, endDate])
}

//////////////////////////////////////////////////////
// MESSAGE (BOOKING LOCKED CHAT)
//////////////////////////////////////////////////////

model Message {
  id        String   @id @default(uuid())
  bookingId String
  senderId  String
  content   String
  createdAt DateTime @default(now())

  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  sender    User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([bookingId])
}

//////////////////////////////////////////////////////
// REVIEW SYSTEM
//////////////////////////////////////////////////////

model Review {
  id         String   @id @default(uuid())
  bookingId  String   @unique
  reviewerId String
  targetId   String
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())

  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  reviewer   User     @relation("ReviewsGiven", fields: [reviewerId], references: [id], onDelete: Cascade)
  target     User     @relation("ReviewsReceived", fields: [targetId], references: [id], onDelete: Cascade)

  @@index([targetId])
}
